require_relative 'test_app_app'

if !Isomorfeus.development?
  require_relative '<%= app_require %>'

  Isomorfeus.zeitwerk.setup
  Isomorfeus.zeitwerk.eager_load

  run <%= app_class %>.app
else
  require_relative '<%= app_require %>'

  Isomorfeus.zeitwerk.enable_reloading
  Isomorfeus.zeitwerk.setup
  Isomorfeus.zeitwerk.eager_load

  run ->(env) do
    write_lock = Isomorfeus.zeitwerk_lock.try_write_lock
    if write_lock
      Isomorfeus.zeitwerk.reload
      Isomorfeus.zeitwerk_lock.release_write_lock
    end
    Isomorfeus.zeitwerk_lock.with_read_lock do
      <%= app_class %>.call env
    end
  end
end
