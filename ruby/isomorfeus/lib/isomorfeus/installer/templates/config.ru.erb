require_relative 'test_app_app'

if !Isomorfeus.development?
  require_relative '<%= app_require %>'

  Isomorfeus.zeitwerk.setup
  Isomorfeus.zeitwerk.eager_load

  run <%= app_class %>.app
else
  require_relative '<%= app_require %>'

  Isomorfeus.zeitwerk.enable_reloading
  Isomorfeus.zeitwerk.setup
  Isomorfeus.zeitwerk.eager_load

  run ->(env) do
    Isomorfeus.zeitwerk_lock.with_write_lock do
      Isomorfeus.zeitwerk.reload
    end
    Isomorfeus.zeitwerk_lock.with_read_lock do
      <%= app_class %>.call env
    end
  end
end
